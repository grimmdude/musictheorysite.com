function topKey(keys,chords){var counts={},result=[];_(keys).each(function(values,key,list){counts[key]=_(values).chain().intersection(this.chords).size().value()},{chords:chords});var max=_(counts).max();return _(counts).each(function(value,key,list){value===this.max&&result.push(key)},{max:max}),result}function namethatkey(){var chords=jQuery.makeArray(jQuery(".selected").map(function(){return jQuery(this).html()})),topkeys=topKey(Keys,chords);jQuery("#result").css("display","block"),jQuery(".selected_slice").removeClass("selected_slice"),jQuery(".selected_slice_minor").removeClass("selected_slice_minor"),jQuery(".selected_key_text").removeClass("selected_key_text"),_(topkeys).each(function(item,index){var id_major=item.replace(" ","_").replace("#","sharp");jQuery("#"+id_major+" .pie").addClass("selected_slice");var id_minor=item.replace(" ","_").replace("#","sharp");jQuery("#"+id_minor+" .pie_minor").addClass("selected_slice_minor");var id_ie_major=item.replace(" ","_").replace("#","sharp").replace("Major","");jQuery("#ie_"+id_ie_major+"Major").addClass("selected_slice");var id_ie_minor=item.replace(" ","_").replace("#","sharp").replace("Minor","");jQuery("#ie_"+id_ie_minor+"Minor").addClass("selected_slice_minor");var id_selected_text=item.replace(" ","_").replace("#","sharp");id_selected_text+="-label",jQuery("#"+id_selected_text).addClass("selected_key_text")}),0==jQuery("#chord_selector td.selected").length&&(jQuery(".selected_slice").removeClass("selected_slice"),jQuery(".selected_slice_minor").removeClass("selected_slice_minor"),jQuery(".selected_key_text").removeClass("selected_key_text"))}function scaleGen(start,scale){function chord_note(degree){return degree-=1,i+degree>=s.length?i+degree-s.length:i+degree}var notes,scales,triads,the_key,s,notes_array,i,start_reference,total;for(notes={sharps:["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],flats:["C","Db","D","Eb","E","F","Gb","G","Ab","A","Bb","B"]},scales={major:[2,2,1,2,2,2],blues:[3,2,1,1,3],natural_minor:[2,1,2,2,1,2],harmonic_minor:[2,1,2,2,1,3],melodic_minor:[2,1,2,2,2,2,1,-2,-2,-1,-2,-2,-1,-2]},triads={major:[4,3],minor:[3,4],dim:[3,3],aug:[4,4]},start=start||0,scaleIntervals=scale?scales[scale]:scales.major,notes_array=scaleIntervals!==scales.major?0===start||1===start||2===start||3===start||5===start||7===start||8===start||10===start?notes.flats:notes.sharps:1===start||3===start||5===start||8===start||10===start?notes.flats:notes.sharps,the_key={the_scale:[],diatonic_triad_notes:[],diatonic_triad_names:[],diatonic_sevenths_notes:[],scale_type:scale,root:notes_array[start],scale_intervals:scaleIntervals},s=the_key.the_scale,Array.prototype.findIndex=function(value){var ctr,i;for(ctr="",i=0;i<this.length;i++)if(this[i]===value)return i;return ctr},start_reference=[],total=0,i=0;i<=scaleIntervals.length;i++){total+=scaleIntervals[i],start_reference.push(total);var current_note=0===i?start:start+start_reference[i-1];current_note>=notes_array.length&&(current_note-=12),s.push(notes_array[current_note])}for(scaleIntervals!==scales.major?(the_key.relative_major=s[2],the_key.relative_major_ref=notes_array.findIndex(s[2])):(the_key.relative_minor=s[5],the_key.relative_minor_ref=notes_array.findIndex(s[5])),scaleIntervals!==scales.major?the_key.pentatonic_scale=[s[0],s[2],s[3],s[4],s[6]]:the_key.pentatonic_scale=[s[0],s[1],s[2],s[4],s[5]],i=0;i<s.length;i++){var third_extend,fifth_extend,M,m,dim;the_key.diatonic_triad_notes.push([s[chord_note(1)],s[chord_note(3)],s[chord_note(5)]]),the_key.diatonic_sevenths_notes.push([s[chord_note(1)],s[chord_note(3)],s[chord_note(5)],s[chord_note(7)]]),third_extend=notes_array.findIndex(s[chord_note(3)])<notes_array.findIndex(s[chord_note(1)])?notes_array.findIndex(s[chord_note(3)])+notes_array.length:notes_array.findIndex(s[chord_note(3)]),fifth_extend=notes_array.findIndex(s[chord_note(5)])<third_extend?notes_array.findIndex(s[chord_note(5)])+notes_array.length:notes_array.findIndex(s[chord_note(5)]),M=third_extend-notes_array.findIndex(s[chord_note(1)])===triads.major[0]&&fifth_extend-third_extend===triads.major[1],m=third_extend-notes_array.findIndex(s[chord_note(1)])===triads.minor[0]&&fifth_extend-third_extend===triads.minor[1],dim=third_extend-notes_array.findIndex(s[chord_note(1)])===triads.dim[0]&&fifth_extend-third_extend===triads.dim[1],aug=third_extend-notes_array.findIndex(s[chord_note(1)])===triads.aug[0]&&fifth_extend-third_extend===triads.aug[1],M7=third_extend-notes_array.findIndex(s[chord_note(1)])===triads.major[0]&&fifth_extend-third_extend===triads.major[1],Dom7=third_extend-notes_array.findIndex(s[chord_note(1)])===triads.major[0]&&fifth_extend-third_extend===triads.major[1],m7=third_extend-notes_array.findIndex(s[chord_note(1)])===triads.major[0]&&fifth_extend-third_extend===triads.major[1],M&&the_key.diatonic_triad_names.push(s[i]+"M"),m&&the_key.diatonic_triad_names.push(s[i]+"m"),dim&&the_key.diatonic_triad_names.push(s[i]+"dim"),aug&&the_key.diatonic_triad_names.push(s[i]+"aug")}return the_key}var Keys={"C Major":["C","Cmaj7","Dm","Dm7","Em","Em7","F","Fmaj7","G","G7","Am","Am7","Bdim"],"C# Major":["C#","C#maj7","D#m","D#m7","E#m","E#m7","F#","F#maj7","G#","G#7","A#m","A#m7","B#dim"],"Db Major":["Db","Dbmaj7","Ebm","Ebm7","Fm","Fm7","Gb","Gbmaj7","Ab","Ab7","Bbm","Bbm7","Cdim"],"D Major":["D","Dmaj7","Em","Em7","F#m","F#m7","G","Gmaj7","A","A7","Bm","Bm7","C#dim"],"D# Major":["D#","D#maj7","E#m","E#m7","F##m","F##m7","G#","G#maj7","A#","A#7","B#m","B#m7","C##dim"],"Eb Major":["Eb","Ebmaj7","Fm","Fm7","Gm","Gm7","Ab","Abmaj7","Bb","Bb7","Cm","Cm7","Ddim"],"E Major":["E","Emaj7","F#m","F#m7","G#m","G#m7","A","Amaj7","B","B7","C#m","C#m7","D#dim"],"F Major":["F","Fmaj7","Gm","Gm7","Am","Am7","Bb","Bbmaj7","C","C7","Dm","Dm7","Edim"],"F# Major":["F#","F#maj7","G#m","G#m7","A#m","A#m7","B","Bmaj7","C#","C#7","D#m","D#m7","E#dim"],"Gb Major":["Gb","Gbmaj7","Abm","Abm7","Bbm","Bbm7","Cb","Cbmaj7","Db","Db7","Ebm","Ebm7","Fdim"],"G Major":["G","Gmaj7","Am","Am7","Bm","Bm7","C","Cmaj7","D","D7","Em","Em7","F#dim"],"G# Major":["G#","G#maj7","A#m","A#m7","B#m","B#m7","C#","C#maj7","D#","D#7","E#m","E#m7","F##dim"],"Ab Major":["Ab","Abmaj7","Bbm","Bbm7","Cm","Cm7","Db","Dbmaj7","Eb","Eb7","Fm","Fm7","Gdim"],"A Major":["A","Amaj7","Bm","Bm7","C#m","C#m7","D","Dmaj7","E","E7","F#m","F#m7","G#dim"],"A# Major":["A#","A#maj7","B#m","B#m7","C##m","C##m7","D#","D#maj7","E#","E#7","F##m","F##m7","G##dim"],"Bb Major":["Bb","Bbmaj7","Cm","Cm7","Dm","Dm7","Eb","Ebmaj7","F","F7","Gm","Gm7","Adim"],"B Major":["B","Bmaj7","C#m","C#m7","D#m","D#m7","E","Emaj7","F#","F#7","G#m","G#m7","A#dim"],"C Minor":["Eb","Ebmaj7","Fm","Fm7","Gm","Gm7","G","G7","Ab","Abmaj7","Bb","Bb7","Cm","Cm7","Ddim"],"G Minor":["Bb","Bbmaj7","Cm","Cm7","Dm","Dm7","D","D7","Eb","Ebmaj7","F","F7","Gm","Gm7","Adim"],"D Minor":["F","Fmaj7","Gm","Gm7","Am","Am7","A","A7","Bb","Bbmaj7","C","C7","Dm","Dm7","Edim"],"A Minor":["C","Cmaj7","Dm","Dm7","Em","Em7","E","E7","F","Fmaj7","G","G7","Am","Am7","Bdim"],"E Minor":["G","Gmaj7","Am","Am7","Bm","Bm7","B","B7","C","Cmaj7","D","D7","Em","Em7","F#dim"],"B Minor":["D","Dmaj7","Em","Em7","F#m","F#m7","F#","F#7","G","Gmaj7","A","A7","Bm","Bm7","C#dim"],"F# Minor":["A","Amaj7","Bm","Bm7","C#m","C#m7","C#","C#7","D","Dmaj7","E","E7","F#m","F#m7","G#dim"],"C# Minor":["E","Emaj7","F#m","F#m7","G#m","G#m7","G#","G#7","A","Amaj7","B","B7","C#m","C#m7","D#dim"],"Db Minor":["E","Emaj7","F#m","F#m7","G#m","G#m7","G#","G#7","A","Amaj7","B","B7","C#m","C#m7","D#dim"],"Ab Minor":["B","Bmaj7","C#m","C#m7","D#m","D#m7","D#","D#7","E","Emaj7","F#","F#7","G#m","G#m7","A#dim"],"Eb Minor":["Gb","Gbmaj7","Abm","Abm7","Bbm","Bbm7","Bb","Bb7","Cb","Cbmaj7","Db","Db7","Ebm","Ebm7","Fdim"],"Bb Minor":["Db","Dbmaj7","Ebm","Ebm7","Fm","Fm7","F","F7","Gb","Gbmaj7","Ab","Ab7","Bbm","Bbm7","Cdim"],"F Minor":["Ab","Abmaj7","Bbm","Bbm7","Cm","Cm7","C","C7","Db","Dbmaj7","Eb","Eb7","Fm","Fm7","Gdim"]};jQuery(function(){jQuery("#key_labels a").attr("href","javascript:;"),jQuery("#toggle_instr").click(function(){jQuery("#instructions").slideToggle("medium",function(){})}),jQuery("#chord_selector tr:odd").addClass("odd"),jQuery("#chord_selector td").addClass("highlight"),jQuery("#chord_selector td").click(function(){jQuery(this).toggleClass("selected"),namethatkey(),ga("send","event","key-identifier","click","chord",jQuery(this).text())}),jQuery("#clear_selected").click(function(){jQuery("#chord_selector td").removeClass("selected"),namethatkey(),ga("send","event","key-identifier","click","clear")}),jQuery("#diatonic_chords td").addClass("jtab"),"Microsoft Internet Explorer"==navigator.appName&&jQuery("#ie_nag").css("display","block"),"Microsoft Internet Explorer"!=navigator.appName?jQuery("#circle_of_fifths").css("display","block"):jQuery("#ie_results").css("display","block")}),$(function(){function update_scale(){$("td.display").text("");var root_note=parseFloat($("#root").val()),scale_type=$("#scale_type").val();$.each(scaleGen(root_note,scale_type),function(key,value){"the_scale"==key&&$("td#display_scale").append(value.join(", ")),"pentatonic_scale"==key&&$("td#display_pent_scale").append(value.join(", ")),"diatonic_triad_names"==key&&$.each(this,function(key,value){$("td#display_triad_names").append(key+1+". "+value+" &rarr;<br />")}),"diatonic_triad_notes"==key&&$.each(this,function(key,value){$("td#display_triad_notes").append(value.join(", ")+"<br /> ")}),"relative_major"==key&&$("td#display_relative").append('<a href=javascript:; title="Go to key">'+value+" Major</a>"),"relative_major_ref"==key&&$("td#display_relative a").click(function(){$("form#scale_select #root").val(value),$("form#scale_select #scale_type").val("major"),update_scale()}),"relative_minor"==key&&$("td#display_relative").append('<a href=javascript:; title="Go to key">'+value+" Minor</a>"),"relative_minor_ref"==key&&$("td#display_relative a").click(function(){$("form#scale_select #root").val(value),$("form#scale_select #scale_type").val("natural_minor"),update_scale()})})}update_scale(),$("form#scale_select").change(function(){update_scale()})}),$(function(){function topChord(chords,notes){var result={exact:[],partial:[]};return _(chords).each(function(values,chord,list){var numNotes=_(this.notes).size(),matchCount=_(values).chain().intersection(this.notes).size().value();numNotes===matchCount&&(_(values).size()===numNotes?result.exact.push(chord):matchCount>=2&&result.partial.push(chord))},{notes:notes}),result}function namethatchord(){var selected_notes,unique_selected_notes,finalResults;selected_notes=$.makeArray($(".selected").map(function(){return $(this).html()})),unique_selected_notes=_.uniq(selected_notes),finalResults=topChord(Chords,unique_selected_notes),$("#chord_results").html(finalResults.partial.join(", ")),$("#exact_results").html(finalResults.exact.join(", ")),0===selected_notes.length&&$("#chord_results").html(""),$("#chosen_notes").html(selected_notes.join(", "))}function clear_notes(){$("#note_selectors a").removeClass("selected"),$("#store_chord").addClass("disabled"),$("#frets_url").val(""),$("#embed_code").val(""),namethatchord()}function load_note_audio(note){var audio_type=".mp3";$("audio#"+note).length||$.ajax({url:"/assets/audio/clean_"+note+audio_type,success:function(){$("<audio/>",{id:note,src:"/assets/audio/clean_"+note+audio_type,preload:"true"}).appendTo("#audio")}})}function build_frets_url(){var string,fret,url="http://musictheorysite.com/namethatchord/?frets";return $(".selected").each(function(){string=$(this).parent().attr("id").substr(0,1),fret=+$(this).index(),url+="&"+string+"="+fret}),url}function build_embed_code(){return"<iframe width='650' height='235' scrolling='no' src='"+build_frets_url()+"&embed' frameborder='0' style='overflow:hidden'></iframe>"}var user_stored_chords={},Chords={C:["C","E","G"],Db:["Db","F","Ab"],D:["D","F#","A"],Eb:["Eb","G","Bb"],E:["E","Ab","B"],F:["F","A","C"],"F#":["F#","Bb","Db"],Gb:["Gb","Bb","Ab"],G:["G","B","D"],Ab:["Ab","C","Eb"],A:["A","Db","E"],Bb:["Bb","D","F"],B:["B","Eb","F#"],Cm:["C","Eb","G"],Dbm:["Db","E","Ab"],Dm:["D","F","A"],Ebm:["Eb","F#","Bb"],Em:["E","G","B"],Fm:["F","Ab","C"],"F#m":["F#","A","Db"],Gm:["G","Bb","D"],Abm:["Ab","B","Eb"],Am:["A","C","E"],Bbm:["Bb","Db","F"],Bm:["B","D","F#"],CM7:["C","E","G","B"],DbM7:["Db","F","Ab","C"],DM7:["D","F#","A","Db"],EbM7:["Eb","G","Bb","D"],EM7:["E","Ab","B","Eb"],FM7:["F","A","C","E"],"F#M7":["F#","Bb","Db","E#"],GbM7:["Gb","Bb","Ab","F"],GM7:["G","B","D","F#"],AbM7:["Ab","C","Eb","G"],AM7:["A","Db","E","Ab"],BbM7:["Bb","D","F","A"],BM7:["B","Eb","F#","Bb","Bb"],Cm7:["C","Eb","G","Bb"],Dbm7:["Db","E","Ab","B"],Dm7:["D","F","A","C"],Ebm7:["Eb","F#","Bb","Db"],Em7:["E","G","B","D"],Fm7:["F","Ab","C","Eb"],"F#m7":["F#","A","Db","E"],Gm7:["G","Bb","D","F"],Abm7:["Ab","B","Eb","F#"],Am7:["A","C","E","G"],Bbm7:["Bb","D","F","Ab"],Bm7:["B","D","F#","A"],C7:["C","E","G","Bb"],Db7:["Db","F","Ab","B"],D7:["D","F#","A","C"],Eb7:["Eb","G","Bb","Db"],E7:["E","Ab","B","D"],F7:["F","A","C","Eb"],"F#7":["F#","Bb","Db","E"],Gb7:["Gb","Bb","Ab","E"],G7:["G","B","D","F"],Ab7:["Ab","C","Eb","Gb","F#"],A7:["A","Db","E","G"],Bb7:["Bb","D","F","Ab"],B7:["B","Eb","F#","A"],Cadd9:["C","D","E","G"],Dbadd9:["Db","Eb","F","Ab"],Dadd9:["D","E","F#","A"],Ebadd9:["Eb","F","G","Bb"],Eadd9:["E","F#","Ab","B"],Fadd9:["F","G","A","C"],"F#add9":["F#","Ab","Bb","Db"],Gbadd9:["Gb","Ab","Bb","Db"],Gadd9:["G","A","B","D"],Abadd9:["Ab","Bb","C","Eb"],Aadd9:["A","B","Db","E"],Bbadd9:["Bb","C","D","F"],Badd9:["B","Db","Eb","F#"],C6:["C","E","G","A"],Db6:["Db","F","Ab","Bb"],D6:["D","F#","A","B"],Eb6:["Eb","G","Bb","C"],E6:["E","Ab","B","Db"],F6:["F","A","C","D"],"F#6":["F#","Bb","Db","Eb"],Gb6:["Gb","Bb","Db","Eb"],G6:["G","B","D","E"],Ab6:["Ab","C","Eb","F"],A6:["A","Db","E","F#"],Bb6:["Bb","D","F","G"],B6:["B","Eb","F#","Ab"],C9:["C","E","G","Bb","D"],Db9:["Db","F","Ab","B","Eb"],D9:["D","F#","A","C","E"],Eb9:["Eb","G","Bb","Db","F"],E9:["E","Ab","B","D","F#"],F9:["F","A","C","Eb","G"],"F#9":["F#","Bb","Db","E","Ab"],Gb9:["Gb","Bb","Ab","E","Ab"],G9:["G","B","D","F","A"],Ab9:["Ab","C","Eb","Gb","F#","Bb"],A9:["A","Db","E","G","B"],Bb9:["Bb","D","F","Ab","C"],B9:["B","Eb","F#","A","Db"]};for(i=0;i<=17;i++){var fret="fret_"+i;$("#e_notes a").eq(i).addClass(fret),$("#B_notes a").eq(i).addClass(fret),$("#G_notes a").eq(i).addClass(fret),$("#D_notes a").eq(i).addClass(fret),$("#A_notes a").eq(i).addClass(fret),$("#E_notes a").eq(i).addClass(fret)}$("#note_selectors a").each(function(){$(this).addClass($(this).text())}),$("#note_selectors a").attr("href","javascript:;"),$("#frets_url, #embed_code").click(function(){$(this).select()}),$("#note_selectors a").click(function(){if(url_params.hasOwnProperty("embed")||($(this).siblings(".selected").length>=1&&$(this).siblings(".selected").removeClass("selected"),$(this).toggleClass("selected"),$(".selected").length?$("#store_chord").removeClass("disabled"):$("#store_chord").addClass("disabled"),$("#frets_url").val(build_frets_url()),$("#embed_code").val(build_embed_code()),namethatchord(),ga("send","event","namethatchord","click","note",jQuery(this).attr("class").replace(" selected",""))),url_params.hasOwnProperty("embed")&&url_params.hasOwnProperty("listen")||!url_params.hasOwnProperty("embed")){load_note_audio($(this).attr("class").split(" ")[0])}}),$("#clear_selections").click(function(){clear_notes(),ga("send","event","namethatchord","click","clear notes")}),$("#store_chord").click(function(){if(!$("#store_chord").is(".disabled")){0===_.size(user_stored_chords)&&$("#stored_chords p").remove();var next_entry_no=_.size(user_stored_chords)+1;user_stored_chords[next_entry_no]={},user_stored_chords[next_entry_no].frets={},user_stored_chords[next_entry_no].notes=[],$(".selected").each(function(){var string=$(this).parent().attr("id"),fret=$(this).attr("class").split(" ")[1],note=$(this).attr("class").split(" ")[2];user_stored_chords[next_entry_no].frets[string]=fret,user_stored_chords[next_entry_no].notes.push(note)}),$("#stored_chords").append($("<div />",{id:"button_group_"+next_entry_no,style:"float:left;"}).addClass("btn-group")),$("<button />",{id:next_entry_no+"_stored",text:next_entry_no}).addClass("btn btn-primary stored_box").appendTo("#button_group_"+next_entry_no),$("#store_chord").addClass("disabled"),ga("send","event","namethatchord","click","store chord")}}),$("#stored_chords").delegate(".stored_box","click",function(){var this_chord=user_stored_chords[parseInt($(this).attr("id"))];clear_notes(),_.each(this_chord,function(value,key){"frets"==key&&_.each(value,function(fret,string){$("#"+string).children("a."+fret).addClass("selected")})}),$("#frets_url").val(build_frets_url()),namethatchord()}),$("#chord_listen").click(function(){$(this).is(".disabled")||($(".selected").each(function(){var note=$(this).attr("class").split(" ")[0];$("audio#"+note).trigger("load"),$("audio#"+note).trigger("play")}),ga("send","event","namethatchord","click","listen to chord"))}),$("#ajaxload").ajaxStart(function(){$(this).show(),$("#chord_listen").addClass("disabled")}),$("#ajaxload").ajaxStop(function(){$(this).hide(),$("#chord_listen").removeClass("disabled")}),"object"==typeof url_params&&($.each(url_params,function(key,value){if(-1!=$.inArray(key,["E","A","D","G","B","e"])){$("#"+key+"_notes").find(".fret_"+value).addClass("selected");var note=$("#"+key+"_notes").find(".fret_"+value).attr("class").split(" ")[0];url_params.hasOwnProperty("embed")||load_note_audio(note)}}),$("#frets_url").val(build_frets_url()),namethatchord())});